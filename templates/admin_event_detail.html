{% extends "base.html" %}

{% block title %}{{ event.title }} verwalten – Filmabende{% endblock %}

{% block content %}
  <section class="card" style="margin-bottom: 2rem;">
    <div class="tag">{{ event.starts_at.strftime('%d.%m.%Y um %H:%M Uhr') }}</div>
    <h1 class="movie-title" style="margin: 0.6rem 0 0.4rem;">{{ event.title }}</h1>
    <p style="color: var(--muted); margin: 0 0 0.6rem;">{{ event.location }}</p>
    {% if event.notes %}
      <p style="margin: 0 0 1rem;">{{ event.notes }}</p>
    {% endif %}
    <div style="display: flex; gap: 1.2rem; flex-wrap: wrap;">
      <span class="badge yes">Zusagen {{ event.confirmed_invites()|length }} / {{ event.capacity }}</span>
      <span class="badge waitlist">Warteliste {{ event.waitlisted_invites()|length }}</span>
      <span class="badge">Absagen {{ event.declined_invites()|length }}</span>
      <a class="btn btn-secondary" href="{{ event.letterboxd_url }}" target="_blank" rel="noreferrer">Letterboxd</a>
    </div>
    <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; margin-top: 1rem;">
      <a class="btn btn-secondary" href="{{ url_for('admin_edit_event', event_id=event.id) }}">Event bearbeiten</a>
      <a class="btn btn-secondary" href="{{ url_for('admin_export_invites', event_id=event.id) }}">Einladungen exportieren</a>
      <form method="post" action="{{ url_for('admin_delete_event', event_id=event.id) }}" style="display: inline;" onsubmit="return confirm('Event wirklich löschen? Dieser Schritt kann nicht rückgängig gemacht werden.');">
        <button class="btn btn-secondary" type="submit" style="border-color: rgba(248, 113, 113, 0.4); color: var(--danger);">Event löschen</button>
      </form>
    </div>
  </section>

  <section class="card" style="margin-bottom: 2rem;">
    <h2 style="margin-top: 0;">Einladungsanfragen</h2>
    {% if event.requested_invites() %}
      <div style="overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>E-Mail</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
            {% for invite in event.requested_invites() %}
              <tr>
                <td>{{ invite.name }}</td>
                <td style="color: var(--muted);">{{ invite.email }}</td>
                <td>
                  <form action="{{ url_for('admin_approve_invite', invite_id=invite.id) }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check-lg"></i> Genehmigen
                    </button>
                  </form>
                  <form action="{{ url_for('admin_reject_invite', invite_id=invite.id) }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="bi bi-x-lg"></i> Ablehnen
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="color: var(--muted);">Keine neuen Einladungsanfragen.</p>
    {% endif %}
  </section>

  <section class="card" style="margin-bottom: 2rem;">
    <h2 style="margin-top: 0;">Gäste einladen</h2>
    <p style="color: var(--muted);">Eine E-Mail pro Zeile (oder kommasepariert). Namen optional Zeile für Zeile zuordnen.</p>
    <form method="post" action="{{ url_for('admin_add_invites', event_id=event.id) }}">
      <div>
        <label for="emails">E-Mails</label>
        <textarea id="emails" name="emails" rows="4" placeholder="gast@example.com"></textarea>
      </div>
      <div>
        <label for="names">Namen (optional)</label>
        <textarea id="names" name="names" rows="4" placeholder="Name passend zur Reihenfolge der E-Mails"></textarea>
      </div>
      <button class="btn" type="submit">Einladungen erzeugen</button>
    </form>
  </section>

  <section class="card">
    <h2 style="margin-top: 0;">Einladungsübersicht</h2>
    {% if event.invites %}
      <div style="overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>E-Mail</th>
              <th>Status</th>
              <th>Sitz</th>
              <th>Link</th>
            </tr>
          </thead>
          {% set status_map = {'yes': 'Zusage', 'waitlist': 'Warteliste', 'no': 'Absage', 'pending': 'Offen', 'requested': 'Angevraagd'} %}
          <tbody>
            {% for invite in event.invites %}
              {% if invite.status != 'requested' %}
                <tr>
                  <td>{{ invite.display_name() }}</td>
                  <td style="color: var(--muted);">{{ invite.email }}</td>
                  <td>
                    <span class="badge {{ invite.status }}">{{ status_map.get(invite.status, invite.status) }}</span>
                    {% if invite.responded_at %}
                      <div style="font-size: 0.7rem; color: var(--muted);">{{ invite.responded_at.strftime('%d.%m.%Y %H:%M') }}</div>
                    {% endif %}
                  </td>
                  <td>{{ invite.seat_number or '-' }}</td>
                  <td style="font-size: 0.75rem;">
                    <a href="{{ invite_links[invite.id] }}" target="_blank" rel="noreferrer">Link öffnen</a>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="color: var(--muted);">Noch keine Einladungen.</p>
    {% endif %}
  </section>
{% endblock %}

